# TinyPNG 递归目录图片压缩工具 🚀

一个基于 node 和 TinyPNG API 的高效图片批量压缩工具，支持递归处理整个目录结构，自动压缩图片并保持原有文件组织结构。

## ✨ 功能特性

### 🎯 核心功能
- **递归目录扫描** - 自动扫描指定目录及其所有子目录中的图片文件
- **批量图片压缩** - 使用 TinyPNG 官方 API 进行高质量图片压缩
- **多格式支持** - 支持 `.jpg`、`.jpeg`、`.png`、`.webp` 格式的图片压缩
- **目录结构保持** - 压缩后的文件保持与原目录相同的文件夹结构
- **非压缩文件复制** - 自动复制 `.svg`、`.gif` 等非压缩格式文件到输出目录

### ⚡ 性能优化
- **多并发处理** - 基于 CPU 核心数自动调整并发数量，提高处理效率
- **智能重试机制** - 失败文件自动重试，最大重试次数可配置
- **任务延迟控制** - 避免过于频繁的 API 请求，防止被限流
- **进度条显示** - 实时显示压缩进度和处理状态

### 🛡️ 错误处理
- **失败文件管理** - 压缩失败的文件单独存储到失败目录
- **独立重试模式** - 支持单独重试之前失败的文件
- **详细错误日志** - 提供详细的错误信息和处理状态
- **网络超时保护** - 设置请求超时时间，避免长时间等待

## 📦 安装要求

### Node.js 环境
- **Node.js** >= 14.0.0
- **npm** 或 **pnpm** 包管理器

### 依赖包安装

```bash
# 使用 npm 安装依赖
npm install

# 或使用 pnpm 安装依赖
pnpm install
```

## 🚀 快速开始


### 1. 准备图片文件
将需要压缩的图片放在 `static` 目录中（或修改配置中的 `SOURCE_ROOT` 路径）

### 2. 运行压缩
```bash
# 执行完整压缩流程
node index.js

# 仅重试之前压缩失败的文件
node index.js --retry-failed
```


## ⚙️ 配置说明

**所有配置项都在 `index.js` 文件顶部的 `CONFIG` 对象中**


## 📖 使用方法

### 基本使用

#### 1. 正常压缩模式
```bash
node index.js
```
**功能说明：**
- 扫描源目录中的所有图片文件
- 使用 TinyPNG API 进行压缩
- 将压缩后的文件保存到输出目录
- 复制非压缩格式文件（如 SVG、GIF）
- 将失败的文件复制到失败目录
- 自动重试失败目录中的文件

#### 2. 仅重试失败模式
```bash
node index.js --retry-failed
```
**功能说明：**
- 只处理之前压缩失败的文件
- 从失败目录中读取文件进行重新压缩
- 成功后从失败目录中移除文件

### 目录结构示例

#### 压缩前的目录结构：
```
项目根目录/
├── static/                    # 源图片目录
│   ├── images/
│   │   ├── photo1.jpg
│   │   ├── photo2.png
│   │   └── icon.svg
│   ├── avatars/
│   │   ├── user1.jpg
│   │   └── user2.png
│   └── banner.webp
├── index.js
└── README.md
```

#### 压缩后的目录结构：
```
项目根目录/
├── static/                    # 原始图片目录（保持不变）
├── compressed_results/        # 压缩后的图片目录
│   ├── images/
│   │   ├── photo1.jpg        # 已压缩
│   │   ├── photo2.png        # 已压缩
│   │   └── icon.svg          # 直接复制
│   ├── avatars/
│   │   ├── user1.jpg         # 已压缩
│   │   └── user2.png         # 已压缩
│   └── banner.webp           # 已压缩
├── failed_images/             # 失败文件目录（如果有失败）
│   └── failed_image.jpg
├── index.js
└── README.md
```

## 📊 处理结果示例

### 控制台输出示例
```
🚀 TinyPNG 递归目录图片压缩工具
[====================] 15/15 100% 0.0s

==================================================
✅ 成功压缩: 13 张
❌ 处理失败: 2 张
📦 原始大小: 25.67 MB
📦 压缩后大小: 18.32 MB
💾 节省空间: 7.35 MB (28.6%)
📁 复制非压缩格式文件完成
📁 所有失败文件已保存到目录: /path/to/failed_images

🎉 初次压缩完成！结果保存在: /path/to/compressed_results

🔁 开始重新压缩失败图片 (2 张)...
[====================] 2/2 100% 0.0s
🎯 重新压缩完成，成功 1 张，失败 1 张
⚠️ 仍有失败文件，保留在失败目录中，需手动处理。
```

## 🔧 高级配置

### 自定义源目录和输出目录
```javascript
const CONFIG = {
  SOURCE_ROOT: path.join(__dirname, 'my-images'),      // 自定义需要压缩的图片目录
  OUTPUT_ROOT: path.join(__dirname, 'compressed'),     // 自定义输出目录
  // ... 其他配置
};
```

### 调整并发数量
```javascript
const CONFIG = {
  MAX_CONCURRENT: 3,  // 设置为固定的并发数
  // 或者
  MAX_CONCURRENT: Math.min(6, os.cpus().length), // 最大不超过6个并发
  // ... 其他配置
};
```

### 


### 调整网络设置
```javascript
const CONFIG = {
  TIMEOUT: 60000,     // 增加超时时间到60秒
  MAX_RETRIES: 5,     // 增加重试次数到5次
  TASK_DELAY: 500,    // 增加任务间延迟到500毫秒
  // ... 其他配置
};
```

## ⚠️ 注意事项

**禁止添加修改 SUPPORTED_FORMATS,这个是 TinyPNG 支持的图片, 添加修改不支持的图片格式会压缩失败**
```javascript
const CONFIG = {
  SUPPORTED_FORMATS: ['.jpg', '.jpeg', '.png', '.webp'],
};
```

### TinyPNG API 限制
- **免费额度**：每月500张图片的免费压缩额度
- **API密钥**：本工具使用 TinyPNG 网页版的接口，无需 API Key
- **请求频率**：建议不要设置过小的 `TASK_DELAY` 值，避免被限流

### 文件处理说明
- **原始文件保护**：工具不会修改或删除源目录中的原始文件
- **覆盖行为**：如果输出目录中已存在同名文件，会被覆盖
- **失败文件**：压缩失败的文件会被复制到失败目录，便于后续处理

### 性能优化建议
- **并发数量**：根据网络状况和机器性能调整 `MAX_CONCURRENT`
- **任务延迟**：网络较慢时可适当增加 `TASK_DELAY`
- **超时时间**：大文件处理时可适当增加 `TIMEOUT` 值


## 📄 许可证

本项目仅供学习和个人使用，请遵守 TinyPNG 的使用条款。

---

**作者**: 无忧  
**版本**: 1.2.0  
**更新时间**: 2025

> 💡 **小贴士**：首次使用建议先用少量图片测试，确认配置正确后再处理大批量文件。 